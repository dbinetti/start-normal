{% extends 'app/base.html' %}

{% load bootstrap4 %}
{% load humanize %}

{% block title %}Connect to Homeroom{% endblock title %}
{% block header %}Connect to Homeroom{% endblock header %}

{% block content %}
  <section class='my-5'>
    <p class='lead mb-5'>
      Ask to join an existing Homeroom <strong>OR</strong> create one of your own.
    </p>
  </section>
  <section class='mt-2 mt-5'>
    <div class='card'>
      <div class='card-header'>
        <h4>Search Homerooms</h4>
      </div>
      <div class='card-body'>
        <div id="searchbox" class='my-5'>
        </div>
        <div id="hits" class='my-5'>
        </div>
      </div>
      {% comment %}
      <div class='card-body'>
        <table class='table table-reponsive-lg'>
          <thead>
            <tr>
              <th>
                Room Parent
              </th>
              <th>
                School(s)
              </th>
              <th>
                Grade(s)
              </th>
              <th>
                Student(s)
              </th>
              <th>
                Ask
              </th>
            </tr>
          </thead>
          <tbody>
            {% for homeroom in homerooms %}
              <tr>
                <td>
                  <a href='{% url "homeroom" homeroom.id %}'>{{homeroom.parent}}</a>
                </td>
                <td>
                  {{homeroom.schools|join:"<br>"|escape|default:"(Empty)"}}
                </td>
                <td>
                  {{homeroom.grades|join:"<br>"|escape|default:"(Empty)"}}
                </td>
                <td>
                  {{homeroom.students.all|join:"<br>"}}
                </td>
                <td>
                  <a href='{% url "ask" homeroom.id student.id %}'>Ask</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan=5>
                  (No existing Homerooms match your School and Grade -- create one!)
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endcomment %}
      <div class='card-footer'>
        <p>
          <a href='{% url "create-homeroom" student.id %}' role='button' class='btn btn-success btn-lg'>Create a Homeroom</a>
        </p>
      </div>
    </div>
  </section>

  {% comment %}
  <section class='my-5'>
    <div class='card'>
      <div class='card-header'>
        <h4>Available Schoolmates</h4>
      </div>
      <div class='card-body'>
        <table class='table table-reponsive-lg'>
          <thead>
            <th>
              Grade
            </th>
            <th>
              Student Name
            </th>
            <th>
              Parent Name
            </th>
            <th>
              Parent Email
            </th>
          </thead>
          <tbody>
            {% for student in students %}
              <tr>
                <td>
                  {{student.get_grade_display}}
                </td>
                <td>
                  {{student.name}}
                </td>
                <td>
                  {{student.parent.user.name}}
                </td>
                <td>
                  <a href='mailto:{{student.parent.user.email}}'>{{student.parent.user.email}}</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
{% endcomment %}
{% endblock content %}

{% block scripts %}
  <script>

    const searchClient = algoliasearch(
      "{{app_id}}",
      "{{search_key}}",
    );

    let search = instantsearch({
      indexName: "{{index_name}}",
      searchClient,
      searchFunction: function(helper) {
        var searchResults = $('.search-results');
        if (helper.state.query === '') {
          searchResults.hide();
          return;
        }
        helper.search();
        searchResults.show();
      }
    });

    search.addWidgets([
      instantsearch.widgets.searchBox({
        container: '#searchbox',
        placeholder: 'Search Homerooms...',
        autofocus: true,
        showReset: false,
        showSubmit: false,
        cssClasses: {
          root: 'root',
          form: 'form',
          input: 'input form-control form-control-large',
        },
      }),
    ]);

    search.addWidgets([
      instantsearch.widgets.infiniteHits({
        container: '#hits',
        templates: {
          item(item) {
            return `
              <strong>${item.parent_name}'s Homeroom</strong><br>
              Size: ${item.size} Student(s)<br>
              School(s): ${item.schools}<br>
              Grade(s): ${item.grades}<br>
              Student(s): ${item.student_names}<br>
              <a href='https://www.startnormal.com/ask/${item.id}/{{student.id}}'>Ask</a>
            `;
          }
        },
        cssClasses: {
          list: 'list',
          item: 'my-3',
          loadPrevious: 'btn btn-primary mt-5',
          loadMore: 'btn btn-primary mt-5',
          disabledLoadPrevious: 'btn btn-primary mt-5',
          disabledLoadMore: 'btn btn-primary mt-5',
        },
      }),
    ]);

    {% comment %}
    search.addWidgets([
      instantsearch.widgets.refinementList({
        container: '#refine',
        attribute: 'get_kind_display',
        // Optional parameters
        operator: string,
        limit: number,
        showMore: boolean,
        showMoreLimit: number,
        searchable: boolean,
        searchablePlaceholder: string,
        searchableIsAlwaysActive: boolean,
        searchableEscapeFacetValues: boolean,
        sortBy: string[]|function,
        templates: object,
        cssClasses: object,
        transformItems: function,
      })
    ]);
    {% endcomment %}
    search.start();

  </script>
{% endblock scripts %}